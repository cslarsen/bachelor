\chapter{Running the thesis code}
\label{chapter:install.vm}

The best way to run the thesis code is to download a virtual machine image.
We used VirtualBox\index{VirtualBox} for running this image, but it should
also work on VMWare\index{VMWare}.  It comes preloaded with
Mininet\index{Mininet}, Open vSwitch\index{Open vSwitch}, POX\index{POX},
  Wireshark\index{Wireshark} and more.

The user \texttt{mininet} has password \texttt{mininet} and has
\texttt{sudo}-rights.

\section{Downloading and verifying the VM image}

The Linux\index{Linux} VM image containing a ready-to-run version of the
code in this thesis, along with all its tools, can be downloaded from
%
\begin{center}
  \href{http://csl.name/bachelor-thesis.vm-invalid-url}{http://csl.name/bachelor-thesis.vm-invalid-url}
  \label{gpg:url}
\end{center}

To verify that this image has not been modified after the time of thesis
submission, you should download the author's GPG-key\index{GPG} (listing
\ref{gpg:key}, p.~\pageref{gpg:key}) and use it to verify the file digest
in (listing \ref{gpg:signature}, p.~\pageref{gpg:signature}).

To import the author's key, you can use \ac{GPG} or any software compatible
with PGP\index{PGP}.  Importing the key is done by running the command
\texttt{gpg --import} and pasting a copy of the author's key, ending the
input by hitting \texttt{CTRL+D}.\footnote{You can also copy the key to a
  file \texttt{key.asc} and importing it with \texttt{gpg --import key.asc}}
%
\begin{Verbatim}
$ gpg --import
# paste in author's key and hit CTRL+D
\end{Verbatim}
%
You should now see they key on your key-ring.
%
\begin{Verbatim}
$ gpg --list-keys
\end{Verbatim}
%
The key's fingerprint should be the same as below:
%
\begin{lstlisting}[label={gpg:key.fingerprint}]
pub   4096R/FA475DD2 2013-04-23 [expires: 2016-04-22]
      Key fingerprint = D611 0F24 4813 9908 1CFE  79BA 1AB4 2C77 FA47 5DD2
uid                  Christian Stigen Larsen (General key) <csl@csl.name>
sub   4096R/D2495ED9 2013-04-23 [expires: 2016-04-22]
\end{lstlisting}

Finally, you need copy the VM image digest (listing \ref{gpg:signature}
\vpageref{gpg:signature}) to a file called
\texttt{bachelor-thesis.vm-invalid-url.asc}, placed in the same directory as
the downloaded VM image \texttt{bachelor-thesis.vm-invalid-url}.  You can then run
\texttt{gpg --verify bachelor-thesis.vm-invalid-url.asc} to verify the
digest against the author's key.\footnote{Note that if you haven't marked the
author's key as \textit{trusted}, you will get a warning about it.
But it should say that the signature is good.}

\begin{Verbatim}
$ gpg --verify mininet-vm-x86_64.vmdk.asc
gpg: Signature made Thu Apr 24 11:52:02 2014 CEST using RSA key ID FA475DD2
gpg: Good signature from "Christian Stigen Larsen (General key) <csl@csl.name>"
\end{Verbatim}

\lstinputlisting[
  caption={GPG signature for the thesis VM image.},
  label={gpg:signature}]{mininet-vm-x86_64.vmdk.asc}

% This text is long and must be on its own page
\begin{lstlisting}[
  float,
  caption={The author's public GPG-key},
  label={gpg:key}]
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1

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
=iAwm
-----END PGP PUBLIC KEY BLOCK-----
\end{lstlisting}
\clearpage % Clear page after this key as it's pretty long.

\section{Setting up the VM image}

In VirtualBox, under settings, network, I have set up adapter 1 with
\textbf{Enable Network Adapter} and \textbf{Attached To} set to
\textbf{NAT}.  Under the advanced options, I have set the \textbf{MAC
address} to \texttt{FEEDFACEBEEF} (this may not be important for the
operation of the tests).

\textbf{Adapter 2} is attached to \textbf{Host-only Adapter} with
\textbf{name} set to \textbf{vboxnet0}.

Adapters 3 and 4 have not been set.  When booting the VM, you should be able
to ping remote hosts on the Internet (but not from within Mininet).

\section{Setting up SSH}
\label{chapter:ssh.setup}

In order to work with the VM, you need to add the following optios to your
local \texttt{\~{}/.ssh/config}.

\begin{verbatim}
Host mininet
  Hostname 192.168.56.102
  User mininet
  ForwardX11 yes
  ForwardAgent yes
  RequestTTY yes
\end{verbatim}

X11-forwarding is required in case you want to start xterms on Mininet
nodes or run Wireshark.\index{Wireshark}  Note that it also forwards your
ssh-agent---you may not strictly need this.  The \texttt{RequestTTY}-option
is \textbf{very important}, because it lets us start terminal programs on the remote
host. Without it, some of the examples here will leave processes running in
the background on the remote host when you SIGINT them (CTRL+D).\footnote{If
you don't use this option, you can manually type \texttt{ssh -t} to request
TTYs correctly.}

You may need to change the \texttt{Hostname}-parameter for your particular
system.  Doing this correctly saves you time when the host computer changes
networks.

To be able to logon passwordless, you need to upload your public key:

\begin{verbatim}
$ cat ~/.ssh/id_rsa.pub | ssh mininet "cat - >> ~/.ssh/authorized_keys"
\end{verbatim}

Boot the VM and make sure you can log on to it without typing a password:

\begin{verbatim}
$ ssh mininet
\end{verbatim}

\section{The thesis source code}

You can find the thesis source code on the Mininet VM under
\texttt{\~{}/bach}.

\section{Running the thesis code}

To start the first example...
\todo{Write instructions on how to run the thesis code here.}

\section{Building programs}

\subsection{Open vSwitch}
To build Open vSwitch on the VM, do the following:

\begin{Verbatim}
$ cd ~/ovs
$ ./boot.sh
$ ./configure --prefix=/usr/local-extras \
              --with-linux=/lib/modules/`uname -r`/build
$ make
$ sudo make install
...
\end{Verbatim}

Follow the steps at
\url{https://github.com/mininet/mininet/wiki/Installing-new-version-of-Open-vSwitch}
for installing it on Mininet.
\todo{Reproduser steg her, s책 vi slipper 책 se p책 link, og slik det funker
  som det skal.}

\subsection{POX}

\todo{hvordan kompilere pox}

\subsection{Thesis code}

The thesis code is mostly written in Python, so no steps are necessary.
The only thing to remember is to use the correct PYTHONPATH.  You are
recommended to use the makefiles for this. We have also added symlinks where
needed, so you should not need to worry about it.

\todo{Hvordan bygge koden v책r, C-koden, osv.}

\section{Running the benchmarks}
\label{chapter:appendix.benchmark}

To run the benchmarks yourself, you first need to set up the Linux VM image
by following the instructions in \ref{chapter:install.vm}
\vpageref{chapter:install.vm}.

You absolutely need to have set up \texttt{ssh} as shown in
\ref{chapter:ssh.setup} \vpageref{chapter:ssh.setup}, because we need
correct allocations of TTYs.

When you have done that, you may want to restart your Mininet before running
benchmarks.  This is to make sure that no processes from previous runs are
hanging in the background.\footnote{There may even be hanging processes from
the time the VM image was uploaded.} The test code mostly takes care of
this, but to be on the safe side, reboot with

\begin{Verbatim}
$ ssh mininet
$ sudo shutdown -r now
\end{Verbatim}

\subsection{Baseline benchmark}
\label{chapter:appendix.baseline.benchmark}

To tun this benchmark, run the following on your local computer

\begin{Verbatim}
$ ssh mininet make bench-baseline
$ ssh mininet make bench-baseline-noflows
\end{Verbatim}

If you prefer to run Mininet and the controller in separate terminals, you
can start each one independently:

\begin{Verbatim}
# Terminal 1 (start first)
$ ssh mininet make bench-baseline-pox

# Terminal 2 (start after POX is up)
$ ssh mininet make bench-baseline-mininet
\end{Verbatim}

After the test runs complete, there are two result files that you can
download locally:

\begin{Verbatim}
$ scp mininet:~/pings.txt mininet:~/pings-noflows.txt .
\end{Verbatim}
